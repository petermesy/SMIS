import { RegistrationControl } from '@/components/RegistrationControl';
import { AddClassSection } from '@/components/AddClassSection';
import { SubjectManagement } from '@/pages/SubjectManagement';
// Helper to print a single student report (detailed, with subject scores, academic year, and semester, and 11 columns)
const handlePrintStudentReport = (student, grade, section, className, allSubjects, rankedStudents) => {
  const schoolName = "SSPS";
  let academicYear = student.academicYear || '';
  let semester = student.semester || '';
  if (!academicYear || !semester) {
    if (student.grades && student.grades.length > 0) {
      academicYear = student.grades[0].academicYear || '';
      semester = student.grades[0].semester || '';
    } else if (student.semester) {
      semester = student.semester;
    }
  }
  // Build a visually organized, modern print layout for the student report
  const allSubjectNames = allSubjects;
  const avgs = rankedStudents.map(s => s.avg).sort((a, b) => a - b);
  let percentile = '100';
  if (avgs.length > 1) {
    const below = avgs.filter(a => a < student.avg).length;
    const equal = avgs.filter(a => a === student.avg).length;
    percentile = (((below + 0.5 * equal) / avgs.length) * 100).toFixed(1);
  }
  // Student info block
  const infoRows = [
    { label: 'Name', value: `${student.firstName} ${student.lastName}` },
    { label: 'Email', value: student.email },
    { label: 'Grade', value: grade },
    { label: 'Section', value: section },
    { label: 'Class', value: className },
    { label: 'Academic Year', value: academicYear || '-' },
    { label: 'Semester', value: semester || '-' },
    { label: 'Date', value: new Date().toLocaleDateString() },
  ];
  // Subject scores table
  let subjectRows = '';
  allSubjectNames.forEach(subject => {
    const subj = student.subjectMap[subject];
    subjectRows += `<tr>
      <td style='padding:6px 12px;border:1px solid #e0e0e0;'>${subject}</td>
      <td style='padding:6px 12px;border:1px solid #e0e0e0;text-align:center;'>${subj ? subj.totalEarned : ''} / ${subj ? subj.totalPossible : ''}</td>
      <td style='padding:6px 12px;border:1px solid #e0e0e0;text-align:center;'>${subj && subj.totalPossible > 0 ? ((subj.totalEarned / subj.totalPossible) * 100).toFixed(1) + '%' : ''}</td>
    </tr>`;
  });
  // Summary block
  const summaryRows = [
    { label: 'Total Score', value: `${student.totalEarned} / ${student.totalPossible}` },
    { label: 'Average (%)', value: `${student.avg.toFixed(1)}%` },
    { label: 'Rank', value: student.rank },
    { label: 'Percentile', value: percentile },
    { label: 'Grade', value: getLetterGrade(student.avg) },
  ];
  const content = `
    <div style='max-width:700px;margin:32px auto;padding:32px 40px 32px 40px;background:#fff;border-radius:12px;box-shadow:0 2px 16px #0001;font-family:sans-serif;'>
      <div style='text-align:center;margin-bottom:24px;'>
        <h2 style='margin:0;font-size:2rem;font-weight:700;color:#1a237e;'>${schoolName}</h2>
        <h3 style='margin:0;font-size:1.2rem;font-weight:500;color:#333;'>Student Academic Report</h3>
      </div>
      <div style='display:flex;gap:32px;justify-content:space-between;flex-wrap:wrap;margin-bottom:32px;'>
        <div style='flex:1 1 220px;'>
          <h4 style='margin:0 0 8px 0;font-size:1.05rem;color:#1976d2;'>Student Information</h4>
          <table style='width:100%;border-collapse:collapse;'>
            ${infoRows.map(row => `<tr><td style='padding:4px 0 4px 0;color:#555;font-weight:500;width:120px;'>${row.label}:</td><td style='padding:4px 0 4px 0;color:#222;'>${row.value}</td></tr>`).join('')}
          </table>
        </div>
        <div style='flex:1 1 220px;'>
          <h4 style='margin:0 0 8px 0;font-size:1.05rem;color:#1976d2;'>Summary</h4>
          <table style='width:100%;border-collapse:collapse;'>
            ${summaryRows.map(row => `<tr><td style='padding:4px 0 4px 0;color:#555;font-weight:500;width:120px;'>${row.label}:</td><td style='padding:4px 0 4px 0;color:#222;'>${row.value}</td></tr>`).join('')}
          </table>
        </div>
      </div>
      <div style='margin-bottom:24px;'>
        <h4 style='margin:0 0 8px 0;font-size:1.05rem;color:#1976d2;'>Subject Scores</h4>
        <table style='width:100%;border-collapse:collapse;margin-bottom:0;'>
          <thead>
            <tr style='background:#f5f5f5;'>
              <th style='padding:6px 12px;border:1px solid #e0e0e0;text-align:left;'>Subject</th>
              <th style='padding:6px 12px;border:1px solid #e0e0e0;text-align:center;'>Score</th>
              <th style='padding:6px 12px;border:1px solid #e0e0e0;text-align:center;'>Percentage</th>
            </tr>
          </thead>
          <tbody>
            ${subjectRows}
          </tbody>
        </table>
      </div>
      <div style='margin-top:32px;text-align:center;font-size:12px;color:#888;'>Generated by Sawla SMIS</div>
    </div>
  `;
  const printWindow = window.open('', '', 'width=900,height=1000');
  if (!printWindow) return;
  printWindow.document.write(`
    <html><head><title>Student Report</title>
    <style>
      @media print {
        body { background: #fff !important; }
        div[style*='box-shadow'] { box-shadow: none !important; }
      }
    </style>
    </head><body style='background:#f5f7fa;font-family:sans-serif;'>
      ${content}
      <script>window.onload = function() { window.print(); }</script>
    </body></html>
  `);
  printWindow.document.close();
};
// Add at the top, after other imports
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
// Helper to get letter grade (moved above PDF export helper)
// Helper to get letter grade (single definition at top-level)
function getLetterGrade(percentage: number): string {
  if (percentage >= 90) return 'A';
  if (percentage >= 85) return 'A-';
  if (percentage >= 80) return 'B+';
  if (percentage >= 75) return 'B';
  if (percentage >= 70) return 'B-';
  if (percentage >= 65) return 'C+';
  if (percentage >= 60) return 'C';
  if (percentage >= 55) return 'C-';
  if (percentage >= 50) return 'D';
  return 'F';
}

// Helper to save all student reports as PDFs (one PDF per student)
const handleBatchSaveStudentReportsAsPDF = async (students, grade, section, className, allSubjects, rankedStudents) => {
  const schoolName = "SSPS";
  for (const student of students) {
    const studentRanked = rankedStudents.find(s => s.id === student.id);
    let subjectRows = '';
    allSubjects.forEach(subject => {
      const subj = student.subjectMap[subject];
      subjectRows += `<tr><td style='padding:4px 8px;border:1px solid #ccc;'>${subject}</td><td style='padding:4px 8px;border:1px solid #ccc;'>${subj ? subj.totalEarned : ''} / ${subj ? subj.totalPossible : ''}</td><td style='padding:4px 8px;border:1px solid #ccc;'>${subj && subj.totalPossible > 0 ? ((subj.totalEarned / subj.totalPossible) * 100).toFixed(1) + '%' : ''}</td></tr>`;
    });
    // Percentile calculation
    const avgs = rankedStudents.map(s => s.avg).sort((a, b) => a - b);
    let percentile = '100';
    if (avgs.length > 1) {
      const below = avgs.filter(a => a < student.avg).length;
      const equal = avgs.filter(a => a === student.avg).length;
      percentile = (((below + 0.5 * equal) / avgs.length) * 100).toFixed(1);
    }
    // Create a hidden div for rendering
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.left = '-9999px';
    container.innerHTML = `
      <div style='width:700px;padding:24px;font-family:sans-serif;background:#fff;'>
      <h2 style='text-align:center;'>${schoolName}</h2>
      <h3 style='text-align:center;'>Student Academic Report</h3>
      <table style='margin:0 auto 16px auto;'>
        <tr><td><b>Name:</b></td><td>${student.firstName} ${student.lastName}</td></tr>
        <tr><td><b>Email:</b></td><td>${student.email}</td></tr>
        <tr><td><b>Grade:</b></td><td>${grade}</td></tr>
        <tr><td><b>Section:</b></td><td>${section}</td></tr>
        <tr><td><b>Class:</b></td><td>${className}</td></tr>
        <tr><td><b>Date:</b></td><td>${new Date().toLocaleDateString()}</td></tr>
      </table>
      <h4>Subject Scores</h4>
      <table style='border-collapse:collapse;width:100%;margin-bottom:16px;'>
        <thead><tr style='background:#f0f0f0;'><th style='padding:4px 8px;border:1px solid #ccc;'>Subject</th><th style='padding:4px 8px;border:1px solid #ccc;'>Score</th><th style='padding:4px 8px;border:1px solid #ccc;'>Percentage</th></tr></thead>
        <tbody>${subjectRows}</tbody>
      </table>
      <table style='margin:0 auto 16px auto;'>
        <tr><td><b>Total Score:</b></td><td>${student.totalEarned} / ${student.totalPossible}</td></tr>
        <tr><td><b>Average (%):</b></td><td>${student.avg.toFixed(1)}%</td></tr>
        <tr><td><b>Rank:</b></td><td>${studentRanked ? studentRanked.rank : ''}</td></tr>
        <tr><td><b>Percentile:</b></td><td>${percentile}</td></tr>
        <tr><td><b>Grade:</b></td><td>${getLetterGrade(student.avg)}</td></tr>
      </table>
      <div style='margin-top:24px;text-align:center;font-size:12px;color:#888;'>Generated by Sawla SMIS</div>
      </div>
    `;
    document.body.appendChild(container);
    // Wait for DOM to render
    await new Promise(res => setTimeout(res, 100));
    const element = container.firstElementChild;
    if (element) {
      const canvas = await html2canvas(element as HTMLElement, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      // Fit image to page
      const imgProps = { width: canvas.width, height: canvas.height };
      let pdfWidth = pageWidth - 40;
      let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      if (pdfHeight > pageHeight - 40) {
        pdfHeight = pageHeight - 40;
        pdfWidth = (imgProps.width * pdfHeight) / imgProps.height;
      }
      pdf.addImage(imgData, 'PNG', 20, 20, pdfWidth, pdfHeight);
      pdf.save(`Student_Report_${student.firstName}_${student.lastName}.pdf`);
    }
    document.body.removeChild(container);
  }
};


import { useState, useEffect } from 'react';
import * as XLSX from 'xlsx';
import { useAuth } from '@/contexts/AuthContext';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Textarea } from '@/components/ui/textarea';
import { BookOpen, Plus, Edit, Trash2, FileText, Award, BarChart3 } from 'lucide-react';
import { toast } from 'sonner';
import { GradeManagement } from '@/components/academics/GradeManagement';
import React from 'react';
import { AcademicYearManagement } from '@/components/academics/AcademicYearManagement';
import { getSubjects, getGrades, getExams, getClasses, getStudentsByClass, createSubject, updateSubject, deleteSubject, createGrade, updateGrade, deleteGrade, createExam, updateExam, deleteExam, getAcademicYears } from '@/lib/api';

interface Subject {
  id: string;
  name: string;
  code: string;
  grade: string;
  credits: number;
  teacher: string;
  teacherId: string;
  description?: string;
}

interface Grade {
  id: string;
  studentId: string;
  studentName: string;
  subjectId: string;
  subjectName: string;
  examType: 'quiz' | 'midterm' | 'final' | 'assignment';
  score: number;
  maxScore: number;
  percentage: number;
  grade: string;
  date: string;
  semester: string;
  academicYear?: string; // <-- Add this property for filtering
  remarks?: string;
  className?: string;
  gradeLevel?: string;
  section?: string;
}

interface Exam {
  id: string;
  title: string;
  subjectId: string;
  subjectName: string;
  grade: string;
  section: string;
  type: 'quiz' | 'midterm' | 'final' | 'assignment';
  date: string;
  duration: number;
  maxScore: number;
  status: 'scheduled' | 'ongoing' | 'completed';
  instructions?: string;
}

export const AcademicManagement = () => {
  // Filter state for admin
  const [selectedAcademicYear, setSelectedAcademicYear] = useState<string>('');
  const [selectedSemester, setSelectedSemester] = useState<string>('');
  const [selectedGrade, setSelectedGrade] = useState<string>('');
  // Academic years and semesters state from backend
  const [academicYears, setAcademicYears] = useState<any[]>([]);
  const [semesters, setSemesters] = useState<any[]>([]);
  // Helper to print a class roster (blank grid) similar to the provided roster image
  const handlePrintRoster = (students: any[], grade: string, section: string, className: string, allSubjects: string[]) => {
    const schoolName = 'Sawla Secondary and Preparatory School';
    const academicYearObj = academicYears.find(y => y.id === selectedAcademicYear);
    const academicYearName = academicYearObj ? academicYearObj.name : (selectedAcademicYear || '');

    // Build header rows for subjects (we'll render subject names vertically by CSS rotate in print)
    const subjectHeaders = allSubjects.map(sub => `<th style="padding:6px;border:1px solid #000;text-align:center;vertical-align:bottom;transform:rotate(-90deg);white-space:nowrap;padding-bottom:18px;">${sub}</th>`).join('');

    // Build rows: for each student, create three rows for I, II, AV (as in the template)
    let bodyRows = '';
    let rno = 1;
    for (const student of students) {
      // three small rows per student
  // Compose student display name as: FirstName FatherName GrandFatherName
  // Some student records don't include a separate 'fatherName' field; fallback to 'lastName'
  const displayName = `${student.firstName || ''} ${(student.fatherName || student.lastName) || ''} ${student.grandFatherName || ''}`.trim();
  const nameCell = `<td rowspan="3" style="border:1px solid #000;padding:6px;vertical-align:middle;width:260px">${displayName}</td>`;
  const rnoCell = `<td rowspan="3" style="border:1px solid #000;padding:6px;width:40px;text-align:center;vertical-align:middle">${rno}</td>`;
  const sexCell = `<td rowspan="3" style="border:1px solid #000;padding:6px;width:40px;text-align:center;vertical-align:middle">${student.gender || ''}</td>`;
  const ageCell = `<td rowspan="3" style="border:1px solid #000;padding:6px;width:40px;text-align:center;vertical-align:middle">${student.age || ''}</td>`;
  // removed separate grandfatherCell: grandfather will be included in displayName

    // Determine semester identifiers: prefer the selected academic year's semesters if available
    const academicYearObj = academicYears.find(y => y.id === selectedAcademicYear) || null;
    const semDefs = (academicYearObj && academicYearObj.semesters && academicYearObj.semesters.length) ? academicYearObj.semesters : (semesters || []);
    const sem1Id = semDefs && semDefs.length > 0 ? (semDefs[0].id || semDefs[0].name) : 'I';
    const sem2Id = semDefs && semDefs.length > 1 ? (semDefs[1].id || semDefs[1].name) : 'II';
  // Use full labels to match printed roster sample
  const semLabels = ['I', 'II', 'AV'];

      // Debug: print semester defs and a sample of grades to help diagnose matching issues
      try {
        // eslint-disable-next-line no-console
        console.debug('handlePrintRoster debug', { semDefs, selectedAcademicYear, gradesSample: (grades || []).slice(0, 30) });
      } catch (e) {}

      // Helper to compute totals for a student+subject+semester
      const getTotals = (studentId: string | number, subject: string, semesterId?: string | number) => {
        const sidNorm = (studentId || '').toString().trim();
        const subjNorm = subject ? subject.toString().trim().toLowerCase() : '';
        const semNorm = semesterId !== undefined && semesterId !== null ? semesterId.toString().trim().toLowerCase() : '';

        const entries = (grades || []).filter((g: any) => {
          try {
            // Normalize student id comparison (allow number/string)
            const gStudent = (g.studentId || g.student?.id || g.studentId)?.toString().trim();
            if (!gStudent || gStudent !== sidNorm) return false;

            // Subject matching: permissive checks
            if (subjNorm) {
              const candidates: string[] = [];
              if (g.subjectName) candidates.push((g.subjectName || '').toString().trim().toLowerCase());
              if (g.subjectId) candidates.push((g.subjectId || '').toString().trim().toLowerCase());
              if (g.subject && typeof g.subject === 'object') {
                if (g.subject.name) candidates.push((g.subject.name || '').toString().trim().toLowerCase());
                if (g.subject.id) candidates.push((g.subject.id || '').toString().trim().toLowerCase());
              }
              // Also consider mapped `subject` state
              if (subjects && subjects.length) {
                const sObj = subjects.find((s: any) => (s.name || '').toString().trim().toLowerCase() === subjNorm);
                if (sObj && sObj.id) candidates.push((sObj.id || '').toString().trim().toLowerCase());
              }
              // If no candidate matched, reject
              const subjectMatch = candidates.length === 0 ? true : candidates.some(c => c === subjNorm || c.includes(subjNorm) || subjNorm.includes(c));
              if (!subjectMatch) return false;
            }

            // Academic year filter (if selected)
            if (selectedAcademicYear) {
              const gAY = (g.academicYear || (g.class && g.class.academicYearId) || (g.academicYearId))?.toString();
              if (gAY && gAY !== selectedAcademicYear && (gAY !== (selectedAcademicYear.toString()))) {
                // allow if nested object with id
                if (!(g.academicYear && g.academicYear.id && g.academicYear.id.toString() === selectedAcademicYear.toString())) {
                  return false;
                }
              }
            }

            // Semester matching (if provided)
            if (semesterId !== undefined && semesterId !== null) {
              let gSem = g.semester;
              if (typeof gSem === 'object') gSem = gSem.id || gSem.name || '';
              const gSemStr = (gSem || g.semesterName || g.semesterId || '')?.toString().trim().toLowerCase();
              const targetSemStr = semNorm;
              if (!gSemStr && !targetSemStr) {
                // both empty – accept
                return true;
              }
              // direct match
              if (gSemStr === targetSemStr) return true;
              // try semDefs
              const found = (semDefs || []).find((s: any) => {
                const sid = (s.id || '').toString().trim().toLowerCase();
                const sname = (s.name || '').toString().trim().toLowerCase();
                return sid === targetSemStr || sname === targetSemStr || sid === gSemStr || sname === gSemStr;
              });
              if (found) return true;
              // numeric/roman mapping
              const mapToNum = (v?: string) => {
                const t = (v || '').toString().trim().toLowerCase();
                if (['i', '1', 'first', 'one'].includes(t)) return 1;
                if (['ii', '2', 'second', 'two'].includes(t)) return 2;
                if (['iii', '3', 'third', 'three'].includes(t)) return 3;
                return null;
              };
              const gNum = mapToNum(gSemStr);
              const tNum = mapToNum(targetSemStr);
              if (gNum && tNum && gNum === tNum) return true;
              // fallback: no semester match
              return false;
            }
            return true;
          } catch (err) {
            return false;
          }
        });

        try {
          // eslint-disable-next-line no-console
          console.debug('getTotals', { studentId: sidNorm, subject: subjNorm, semesterId: semNorm, matchedEntriesCount: entries.length, matchedEntries: entries.slice(0,5) });
        } catch (e) {}

        const totalEarned = entries.reduce((s: number, e: any) => s + (Number(e.score ?? e.pointsEarned ?? 0)), 0);
        const totalPossible = entries.reduce((s: number, e: any) => s + (Number(e.maxScore ?? e.totalPoints ?? 0)), 0);
        return { totalEarned, totalPossible };
      };

      // For each of the three subrows (I, II, AV), create subject cells with values
      const semIds = [sem1Id, sem2Id];
      // precompute semester totals per student
      const semTotalsPerStudent: Array<{ earned: number; possible: number }[]> = [];
      // compute for sem1 and sem2
      const semTotals = semIds.map((sId) => {
        const tAll = allSubjects.reduce((acc, subj) => {
          // compute semester-specific totals only (do NOT fallback to combined subjectMap here)
          const t = getTotals(student.id, subj, sId) || { totalEarned: 0, totalPossible: 0 };
          return { earned: acc.earned + (t.totalEarned || 0), possible: acc.possible + (t.totalPossible || 0) };
        }, { earned: 0, possible: 0 });
        return tAll;
      });

      for (let i = 0; i < 3; i++) {
        let row = '<tr>';
        if (i === 0) {
          row += rnoCell + nameCell + sexCell + ageCell;
        }
        // semester label cell
        row += `<td style="border:1px solid #000;padding:6px;text-align:center;width:60px">${semLabels[i]}</td>`;

        // fill subject cells: for I and II rows show semester totals, for AV show percentage average across both semesters
        for (let j = 0; j < allSubjects.length; j++) {
          const subj = allSubjects[j];
          if (i === 0 || i === 1) {
            const semId = semIds[i];
            // For semester rows, use semester-specific totals only
            const t = getTotals(student.id, subj, semId) || { totalEarned: 0, totalPossible: 0 };
            const cellVal = (t && (t.totalEarned || t.totalEarned === 0)) ? `${t.totalEarned}` : '';
            row += `<td style="border:1px solid #000;padding:6px;width:60px;height:22px;text-align:center">${cellVal}</td>`;
          } else {
            // AV row: compute from semester totals when available; otherwise fall back to combined subjectMap
            const t1 = getTotals(student.id, subj, semIds[0]) || null;
            const t2 = getTotals(student.id, subj, semIds[1]) || null;
            const v1 = (t1 && (t1.totalEarned || t1.totalEarned === 0)) ? Number(t1.totalEarned) : null;
            const v2 = (t2 && (t2.totalEarned || t2.totalEarned === 0)) ? Number(t2.totalEarned) : null;
            let avgVal = '';
            if (v1 !== null && v2 !== null) {
              avgVal = ((Math.round(((v1 + v2) / 2) * 10) / 10)).toString();
            } else if (v1 !== null) {
              avgVal = (Math.round(v1 * 10) / 10).toString();
            } else if (v2 !== null) {
              avgVal = (Math.round(v2 * 10) / 10).toString();
            } else {
              const subjMap = student.subjectMap && student.subjectMap[subj];
              if (subjMap && subjMap.totalEarned !== undefined) {
                avgVal = (Math.round((Number(subjMap.totalEarned || 0)) * 10) / 10).toString();
              }
            }
            row += `<td style="border:1px solid #000;padding:6px;width:60px;height:22px;text-align:center">${avgVal}</td>`;
          }
        }

        // trailing columns: show semester totals and combined averages
        if (i === 0 || i === 1) {
          const st = semTotals[i] || { earned: 0, possible: 0 };
          const totalCell = st.possible > 0 ? `${st.earned} / ${st.possible}` : '';
          const avgCell = st.possible > 0 ? ((st.earned / st.possible) * 100).toFixed(1) + '%' : '';
          row += `<td style="border:1px solid #000;padding:6px;width:60px;text-align:center">${totalCell}</td>`; // Total
          row += `<td style="border:1px solid #000;padding:6px;width:60px;text-align:center">${avgCell}</td>`; // Average
        } else {
          const combined = { earned: (semTotals[0]?.earned || 0) + (semTotals[1]?.earned || 0), possible: (semTotals[0]?.possible || 0) + (semTotals[1]?.possible || 0) };
          const totalCell = combined.possible > 0 ? `${combined.earned} / ${combined.possible}` : '';
          const avgCell = combined.possible > 0 ? ((combined.earned / combined.possible) * 100).toFixed(1) + '%' : '';
          row += `<td style="border:1px solid #000;padding:6px;width:60px;text-align:center">${totalCell}</td>`; // Total
          row += `<td style="border:1px solid #000;padding:6px;width:60px;text-align:center">${avgCell}</td>`; // Average
        }
        // Rank/Cond/Attn left blank for now
        row += `<td style="border:1px solid #000;padding:6px;width:60px"></td>`; // Rank
        row += `<td style="border:1px solid #000;padding:6px;width:60px"></td>`; // Cond
        row += `<td style="border:1px solid #000;padding:6px;width:60px"></td>`; // Attn
        row += '</tr>';
        bodyRows += row;
      }
      rno++;
    }

  const headerSubjectsCount = allSubjects.length;

    const content = `
      <div style="font-family:Arial,Helvetica,sans-serif;padding:18px;">
        <div style="text-align:center;margin-bottom:12px;">
          <h2 style="margin:0;font-size:18px;font-weight:700">${schoolName}</h2>
          <div style="font-size:14px;margin-top:6px;font-weight:600">Student's Roster for Grade ${grade} ${section ? ` / Section ${section}` : ''}</div>
          <div style="font-size:12px;margin-top:4px">Academic year: ${academicYearName || '____ E.C'} &nbsp;&nbsp; Grade & Section: ${grade} ${section}</div>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:12px;margin-top:12px;">
          <thead>
              <tr>
              <th style="border:1px solid #000;padding:6px;width:40px">R N o.</th>
              <th style="border:1px solid #000;padding:6px;width:260px">Student's name</th>
              <th style="border:1px solid #000;padding:6px;width:40px">Sex</th>
              <th style="border:1px solid #000;padding:6px;width:40px">Age</th>
              <th style="border:1px solid #000;padding:6px">Semester</th>
              ${subjectHeaders}
              <th style="border:1px solid #000;padding:6px;width:60px">Total</th>
              <th style="border:1px solid #000;padding:6px;width:60px">Average</th>
              <th style="border:1px solid #000;padding:6px;width:60px">Rank</th>
              <th style="border:1px solid #000;padding:6px;width:60px">Cond</th>
              <th style="border:1px solid #000;padding:6px;width:60px">Attn</th>
            </tr>
          </thead>
          <tbody>
            ${bodyRows}
          </tbody>
        </table>

        <div style="margin-top:18px;font-size:12px">School principal name: ____________________________ &nbsp;&nbsp; Sign: ______________________</div>
      </div>
    `;

    const printWindow = window.open('', '', 'width=1100,height=900');
    if (!printWindow) return;
    printWindow.document.write(`
      <html><head><title>Class Roster - ${grade} ${section}</title>
      <style>
        @media print { th { -webkit-print-color-adjust: exact; } }
        /* Prevent rotated headers from clipping in some browsers */
        th { vertical-align: bottom; }
      </style>
      </head><body>
        ${content}
        <script>window.onload = function(){ window.print(); }</script>
      </body></html>
    `);
    printWindow.document.close();
  };
  // Export a single section to Excel, including subject-wise scores
  const exportSectionToExcel = (grade: string, section: string, className: string, students: any[]) => {
    const getStudentGrades = (studentId: string) => grades.filter(g => g.studentId === studentId);
    const studentsWithAvg = students.map((student: any) => {
      const studentGrades = getStudentGrades(student.id);
      const totalEarned = studentGrades.reduce((sum, g) => sum + (g.score || 0), 0);
      const totalPossible = studentGrades.reduce((sum, g) => sum + (g.maxScore || 0), 0);
      const avg = totalPossible > 0 ? (totalEarned / totalPossible) * 100 : 0;
      // Subject-wise breakdown
      const subjectMap: Record<string, { totalEarned: number; totalPossible: number }> = {};
      studentGrades.forEach(g => {
        if (!subjectMap[g.subjectName]) subjectMap[g.subjectName] = { totalEarned: 0, totalPossible: 0 };
        subjectMap[g.subjectName].totalEarned += g.score || 0;
        subjectMap[g.subjectName].totalPossible += g.maxScore || 0;
      });
      return { ...student, totalEarned, totalPossible, avg, subjectMap };
    });
    studentsWithAvg.sort((a, b) => b.avg - a.avg || a.firstName.localeCompare(b.firstName));
    let lastAvg = null;
    let lastRank = 0;
    let actualRank = 0;
    const rankedStudents = studentsWithAvg.map((student) => {
      actualRank++;
      if (lastAvg === student.avg) {
        return { ...student, rank: lastRank };
      } else {
        lastAvg = student.avg;
        lastRank = actualRank;
        return { ...student, rank: lastRank };
      }
    });
    // Main summary rows
    // Collect all unique subjects for this section for consistent column order
    const allSubjects = Array.from(new Set(rankedStudents.flatMap(s => Object.keys(s.subjectMap))));
    // Calculate percentiles for the class
    const avgs = rankedStudents.map(s => s.avg).sort((a, b) => a - b);
    const getPercentile = (avg: number) => {
      if (avgs.length === 1) return 100;
      const below = avgs.filter(a => a < avg).length;
      const equal = avgs.filter(a => a === avg).length;
      // Percentile rank: percentage of scores below this one, plus half of those equal
      return (((below + 0.5 * equal) / avgs.length) * 100).toFixed(1);
    };
    const rows = rankedStudents.map(student => {
      const row: any = {
        Grade: grade,
        Section: section,
        Class: className,
        Student: `${student.firstName} ${student.lastName}`,
        Email: student.email
      };
      // Add subject-wise scores first
      allSubjects.forEach(subject => {
        row[`Subject: ${subject} Score`] = student.subjectMap[subject]
          ? `${student.subjectMap[subject].totalEarned} / ${student.subjectMap[subject].totalPossible}`
          : '';
      });
      // Then total score, average, percentage, rank, percentile, grade letter
      row['Total Score'] = `${student.totalEarned} / ${student.totalPossible}`;
      row['Average (%)'] = student.avg.toFixed(1);
      row['Percentage'] = student.totalPossible > 0 ? ((student.totalEarned / student.totalPossible) * 100).toFixed(1) + '%': '';
      row['Percentile'] = getPercentile(student.avg);
      row['Rank'] = student.rank;
      row['GradeLetter'] = getLetterGrade(student.avg);
      return row;
    });
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, `${grade} ${section}`);
    XLSX.writeFile(wb, `student_summary_${grade}_${section}.xlsx`);
  };

  // Export all classes/sections to Excel (all summaries in one file, each section as a sheet)
  const exportAllSectionsToExcel = () => {
    // Rebuild gradeSectionMap fresh from classStudentMap to ensure all data is included
    const gradeSectionMap: Record<string, Record<string, { className: string; students: any[] }>> = {};
    Object.values(classStudentMap).forEach((cls: any) => {
      const grade = cls.grade?.name || 'Unknown Grade';
      const section = cls.section?.name || 'Unknown Section';
      if (!gradeSectionMap[grade]) gradeSectionMap[grade] = {};
      if (!gradeSectionMap[grade][section]) gradeSectionMap[grade][section] = { className: cls.name, students: [] };
      gradeSectionMap[grade][section].students = (cls.students || []); // Overwrite, not push, to avoid duplicates
    });
    const wb = XLSX.utils.book_new();
    Object.entries(gradeSectionMap).forEach(([grade, sectionMap]) => {
      Object.entries(sectionMap).forEach(([section, { className, students }]) => {
        const getStudentGrades = (studentId: string) => grades.filter(g => g.studentId === studentId);
        const studentsWithAvg = students.map((student: any) => {
          const studentGrades = getStudentGrades(student.id);
          const totalEarned = studentGrades.reduce((sum, g) => sum + (g.score || 0), 0);
          const totalPossible = studentGrades.reduce((sum, g) => sum + (g.maxScore || 0), 0);
          const avg = totalPossible > 0 ? (totalEarned / totalPossible) * 100 : 0;
          // Subject-wise breakdown
          const subjectMap: Record<string, { totalEarned: number; totalPossible: number }> = {};
          studentGrades.forEach(g => {
            if (!subjectMap[g.subjectName]) subjectMap[g.subjectName] = { totalEarned: 0, totalPossible: 0 };
            subjectMap[g.subjectName].totalEarned += g.score || 0;
            subjectMap[g.subjectName].totalPossible += g.maxScore || 0;
          });
          return { ...student, totalEarned, totalPossible, avg, subjectMap };
        });
        studentsWithAvg.sort((a, b) => b.avg - a.avg || a.firstName.localeCompare(b.firstName));
        let lastAvg = null;
        let lastRank = 0;
        let actualRank = 0;
        const rankedStudents = studentsWithAvg.map((student) => {
          actualRank++;
          if (lastAvg === student.avg) {
            return { ...student, rank: lastRank };
          } else {
            lastAvg = student.avg;
            lastRank = actualRank;
            return { ...student, rank: lastRank };
          }
        });
        // Collect all unique subjects for this section for consistent column order
        const allSubjects = Array.from(new Set(rankedStudents.flatMap(s => Object.keys(s.subjectMap))));
        // Calculate percentiles for the class
        const avgs = rankedStudents.map(s => s.avg).sort((a, b) => a - b);
        const getPercentile = (avg: number) => {
          if (avgs.length === 1) return 100;
          const below = avgs.filter(a => a < avg).length;
          const equal = avgs.filter(a => a === avg).length;
          const total = below + equal;
          return total > 0 ? ((below + 0.5 * equal) / avgs.length * 100).toFixed(1) : '0.0';
        };
        const rows = rankedStudents.map(student => {
          const row: any = {
            Grade: grade,
            Section: section,
            Class: className,
            Student: `${student.firstName} ${student.lastName}`,
            Email: student.email
          };
          allSubjects.forEach(subject => {
            row[`Subject: ${subject} Score`] = student.subjectMap[subject]
              ? `${student.subjectMap[subject].totalEarned} / ${student.subjectMap[subject].totalPossible}`
              : '';
          });
          row['Total Score'] = `${student.totalEarned} / ${student.totalPossible}`;
          row['Average (%)'] = student.avg.toFixed(1);
          row['Percentage'] = student.totalPossible > 0 ? ((student.totalEarned / student.totalPossible) * 100).toFixed(1) + '%': '';
          row['Percentile'] = getPercentile(student.avg);
          row['Rank'] = student.rank;
          row['GradeLetter'] = getLetterGrade(student.avg);
          return row;
        });
        const ws = XLSX.utils.json_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, `${grade} ${section}`);
      });
    });
    XLSX.writeFile(wb, 'student_summary_all_classes.xlsx');
  };
  // Helper to print all student reports for a section in one window, each on a new page
  const handleBatchPrintStudentReports = (students, grade, section, className, allSubjects, rankedStudents) => {
    const schoolName = "SSPS";
    let content = '';
    students.forEach(student => {
      const studentRanked = rankedStudents.find(s => s.id === student.id);
      let subjectRows = '';
      allSubjects.forEach(subject => {
        const subj = student.subjectMap[subject];
        subjectRows += `<tr>
          <td style='padding:8px 12px;border:1px solid #e5e7eb;background:#f9fafb;'>${subject}</td>
          <td style='padding:8px 12px;border:1px solid #e5e7eb;'>${subj ? subj.totalEarned : ''} / ${subj ? subj.totalPossible : ''}</td>
          <td style='padding:8px 12px;border:1px solid #e5e7eb;'>${subj && subj.totalPossible > 0 ? ((subj.totalEarned / subj.totalPossible) * 100).toFixed(1) + '%' : ''}</td>
        </tr>`;
      });
      // Percentile calculation
      const avgs = rankedStudents.map(s => s.avg).sort((a, b) => a - b);
      let percentile = '100';
      if (avgs.length > 1) {
        const below = avgs.filter(a => a < student.avg).length;
        const equal = avgs.filter(a => a === student.avg).length;
        percentile = (((below + 0.5 * equal) / avgs.length) * 100).toFixed(1);
      }
      content += `
        <div style='page-break-after: always; padding: 32px 0; width: 800px; margin: 0 auto;'>
          <div style='display: flex; align-items: center; justify-content: center; margin-bottom: 16px;'>
            <img src='https://i.ibb.co/6b8n6kK/sawla-logo.png' alt='School Logo' style='height: 60px; margin-right: 16px;' onerror="this.style.display='none'" />
            <div>
              <h2 style='margin:0;font-size:2rem;font-weight:700;color:#1e293b;text-align:left;'>${schoolName}</h2>
              <div style='font-size:1.1rem;color:#64748b;text-align:left;'>Student Academic Report</div>
            </div>
          </div>
          <div style='display: flex; gap: 32px; margin-bottom: 24px;'>
            <div style='flex:1;'>
              <table style='width:100%;border-collapse:collapse;'>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Name:</td><td style='padding:6px 0;'>${student.firstName} ${student.lastName}</td></tr>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Email:</td><td style='padding:6px 0;'>${student.email}</td></tr>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Grade:</td><td style='padding:6px 0;'>${grade}</td></tr>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Section:</td><td style='padding:6px 0;'>${section}</td></tr>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Class:</td><td style='padding:6px 0;'>${className}</td></tr>
              </table>
            </div>
            <div style='flex:1;'>
              <table style='width:100%;border-collapse:collapse;'>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Date:</td><td style='padding:6px 0;'>${new Date().toLocaleDateString()}</td></tr>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Rank:</td><td style='padding:6px 0;'>${studentRanked ? studentRanked.rank : ''}</td></tr>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Percentile:</td><td style='padding:6px 0;'>${percentile}</td></tr>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Grade Letter:</td><td style='padding:6px 0;'>${getLetterGrade(student.avg)}</td></tr>
              </table>
            </div>
          </div>
          <div style='margin-bottom: 24px;'>
            <h4 style='margin:0 0 8px 0;font-size:1.1rem;color:#1e293b;'>Subject Scores</h4>
            <table style='border-collapse:collapse;width:100%;box-shadow:0 1px 4px #e5e7eb;'>
              <thead>
                <tr style='background:#f1f5f9;'>
                  <th style='padding:8px 12px;border:1px solid #e5e7eb;text-align:left;'>Subject</th>
                  <th style='padding:8px 12px;border:1px solid #e5e7eb;text-align:left;'>Score</th>
                  <th style='padding:8px 12px;border:1px solid #e5e7eb;text-align:left;'>Percentage</th>
                </tr>
              </thead>
              <tbody>${subjectRows}</tbody>
            </table>
          </div>
          <div style='display: flex; gap: 32px;'>
            <div style='flex:1;'>
              <table style='width:100%;border-collapse:collapse;'>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Total Score:</td><td style='padding:6px 0;'>${student.totalEarned} / ${student.totalPossible}</td></tr>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Average (%):</td><td style='padding:6px 0;'>${student.avg.toFixed(1)}%</td></tr>
              </table>
            </div>
            <div style='flex:1;'>
              <table style='width:100%;border-collapse:collapse;'>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Academic Year:</td><td style='padding:6px 0;'>${student.academicYear || '-'}</td></tr>
                <tr><td style='font-weight:600;color:#334155;padding:6px 0;'>Semester:</td><td style='padding:6px 0;'>${student.semester || '-'}</td></tr>
              </table>
            </div>
          </div>
          <div style='margin-top:32px;text-align:center;font-size:12px;color:#888;'>Generated by Sawla SMIS</div>
        </div>
      `;
    });
    const printWindow = window.open('', '', 'width=900,height=1000');
    if (!printWindow) return;
    printWindow.document.write(`
      <html><head><title>All Student Reports</title>
      <style>
        @media print { div[style*='page-break-after'] { page-break-after: always; } }
        body { background: #f8fafc; }
      </style>
      </head><body style='font-family:sans-serif;background:#f8fafc;'>
        ${content}
        <script>window.onload = function() { window.print(); }</script>
      </body></html>
    `);
    printWindow.document.close();
  };

  // Fetch academic years and semesters from backend
  useEffect(() => {
    const fetchAcademicYears = async () => {
      try {
        const years = await getAcademicYears();
        setAcademicYears(years);
        // Set semesters from selected academic year object
        if (selectedAcademicYear) {
          const yearObj = years.find((y: any) => y.id === selectedAcademicYear);
          setSemesters(yearObj?.semesters || []);
        } else {
          setSemesters([]);
        }
      } catch (e) {
        setAcademicYears([]);
        setSemesters([]);
      }
    };
    fetchAcademicYears();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedAcademicYear]);

  // Top-level inline roster renderer (component scope) so it can be reused by multiple tabs
  const rosterInlineRenderer = (rankedStudents: any[], allSubjects: string[], gradeName: string, sectionName: string, classNameStr: string) => {
    if (!selectedAcademicYear) return null;
    // Determine semester ids (prefer academic year's semesters)
    const academicYearObj = academicYears.find((y: any) => y.id === selectedAcademicYear) || null;
    const semDefs = (academicYearObj && academicYearObj.semesters && academicYearObj.semesters.length) ? academicYearObj.semesters : (semesters || []);
    const sem1Id = semDefs && semDefs.length > 0 ? (semDefs[0].id || semDefs[0].name) : 'I';
    const sem2Id = semDefs && semDefs.length > 1 ? (semDefs[1].id || semDefs[1].name) : 'II';
    const semIds = [sem1Id, sem2Id];
    const semLabels = ['I', 'II', 'AV'];

    const getTotalsLocal = (studentId: string | number, subject: string, semesterId?: string | number) => {
      const sidNorm = (studentId || '').toString().trim();
      const subjNorm = subject ? subject.toString().trim().toLowerCase() : '';
      const semNorm = semesterId !== undefined && semesterId !== null ? semesterId.toString().trim().toLowerCase() : '';
      const entries = grades.filter((g: any) => {
        try {
          const gStudent = (g.studentId || (g.student && g.student.id))?.toString().trim();
          if (!gStudent || gStudent !== sidNorm) return false;
          if (subjNorm) {
            const candidates: string[] = [];
            if (g.subjectName) candidates.push((g.subjectName || '').toString().trim().toLowerCase());
            if (g.subjectId) candidates.push((g.subjectId || '').toString().trim().toLowerCase());
            if (g.subject && typeof g.subject === 'object') {
              if (g.subject.name) candidates.push((g.subject.name || '').toString().trim().toLowerCase());
              if (g.subject.id) candidates.push((g.subject.id || '').toString().trim().toLowerCase());
            }
            if (candidates.length > 0) {
              const match = candidates.some(c => c === subjNorm || c.includes(subjNorm) || subjNorm.includes(c));
              if (!match) return false;
            }
          }
          if (selectedAcademicYear) {
            const gAY = (g.academicYear || (g.class && g.class.academicYearId) || g.academicYearId)?.toString();
            if (gAY && gAY !== selectedAcademicYear && !(g.academicYear && g.academicYear.id && g.academicYear.id.toString() === selectedAcademicYear.toString())) return false;
          }
          if (semesterId !== undefined && semesterId !== null) {
            let gSem = g.semester;
            if (typeof gSem === 'object') gSem = g.semester.id || g.semester.name || gSem;
            const gSemStr = (gSem || g.semesterName || g.semesterId || '')?.toString().trim().toLowerCase();
            const targetSemStr = semNorm;
            if (gSemStr === targetSemStr) return true;
            const mapToNum = (v?: string) => {
              const t = (v || '').toString().trim().toLowerCase();
              if (['i', '1', 'first', 'one'].includes(t)) return 1;
              if (['ii', '2', 'second', 'two'].includes(t)) return 2;
              return null;
            };
            const gNum = mapToNum(gSemStr);
            const tNum = mapToNum(targetSemStr);
            if (gNum && tNum && gNum === tNum) return true;
            return false;
          }
          return true;
        } catch (err) {
          return false;
        }
      });
      const totalEarned = entries.reduce((s: number, e: any) => s + (Number(e.score ?? e.pointsEarned ?? 0)), 0);
      const totalPossible = entries.reduce((s: number, e: any) => s + (Number(e.maxScore ?? e.totalPoints ?? 0)), 0);
      return { totalEarned, totalPossible };
    };

    // Render JSX table (three rows per student: sem1, sem2, avg)
    return (
      <div className="mb-4">
        <h6 className="text-sm font-semibold mb-2">Roster View ({gradeName} - {sectionName})</h6>
        <div className="overflow-x-auto">
          <table className="w-full border text-sm">
            <thead>
                <tr className="bg-gray-50">
                <th className="p-2 border">R N o.</th>
                <th className="p-2 border">Student</th>
                <th className="p-2 border">Email</th>
                <th className="p-2 border">Sex</th>
                <th className="p-2 border">Age</th>
                <th className="p-2 border">Semester</th>
                {allSubjects.map(sub => <th key={sub} className="p-2 border text-center">{sub}</th>)}
                <th className="p-2 border">Total</th>
                <th className="p-2 border">Average</th>
                <th className="p-2 border">Rank</th>
                <th className="p-2 border">Cond</th>
                <th className="p-2 border">Attn</th>
              </tr>
            </thead>
            <tbody>
              {rankedStudents.map((student: any, idx: number) => {
                const semTotals = semIds.map((sId) => {
                  const tAll = allSubjects.reduce((acc, subj) => {
                    const t = getTotalsLocal(student.id, subj, sId) || { totalEarned: 0, totalPossible: 0 };
                    return { earned: acc.earned + (t.totalEarned || 0), possible: acc.possible + (t.totalPossible || 0) };
                  }, { earned: 0, possible: 0 });
                  return tAll;
                });
                const combined = { earned: (semTotals[0]?.earned || 0) + (semTotals[1]?.earned || 0), possible: (semTotals[0]?.possible || 0) + (semTotals[1]?.possible || 0) };
                return (
                  <>
                    {[0,1,2].map(i => {
                      return (
                        <tr key={`${student.id}-${i}`} className="border hover:bg-gray-50">
                          {i === 0 && (
                            <>
                              <td rowSpan={3} className="p-2 border align-middle text-center">{idx + 1}</td>
                              <td rowSpan={3} className="p-2 border align-middle">{`${student.firstName || ''} ${(student.fatherName || student.lastName) || ''} ${student.grandFatherName || ''}`.trim()}</td>
                              <td rowSpan={3} className="p-2 border align-middle">{student.email || ''}</td>
                              <td rowSpan={3} className="p-2 border align-middle text-center">{student.gender || ''}</td>
                              <td rowSpan={3} className="p-2 border align-middle text-center">{student.age || ''}</td>
                            </>
                          )}
                          <td className="p-2 border text-center">{semLabels[i]}</td>
                          {allSubjects.map(subj => {
                            if (i === 0 || i === 1) {
                              const semId = semIds[i];
                              const t = getTotalsLocal(student.id, subj, semId) || { totalEarned: 0, totalPossible: 0 };
                              let cellVal = (t && (t.totalEarned || t.totalEarned === 0)) ? `${t.totalEarned}` : '';
                              // Fallback: if no semester-specific entry found, try student's subjectMap (combined total)
                              if ((cellVal === '' || cellVal === null) && student.subjectMap && student.subjectMap[subj] && (student.subjectMap[subj].totalEarned !== undefined)) {
                                const sVal = Number(student.subjectMap[subj].totalEarned || 0);
                                cellVal = sVal || sVal === 0 ? `${sVal}` : '';
                              }
                              const cell = cellVal === '' ? '-' : cellVal;
                              return <td key={subj} className="p-2 border text-center">{cell}</td>;
                            }
                            const t1 = getTotalsLocal(student.id, subj, semIds[0]) || null;
                            const t2 = getTotalsLocal(student.id, subj, semIds[1]) || null;
                            const v1 = (t1 && (t1.totalEarned || t1.totalEarned === 0)) ? Number(t1.totalEarned) : null;
                            const p1 = (t1 && (t1.totalPossible || t1.totalPossible === 0)) ? Number(t1.totalPossible) : null;
                            const v2 = (t2 && (t2.totalEarned || t2.totalEarned === 0)) ? Number(t2.totalEarned) : null;
                            const p2 = (t2 && (t2.totalPossible || t2.totalPossible === 0)) ? Number(t2.totalPossible) : null;
                            let avgVal = '-';
                            // If both semester totals available, average their raw earned values
                            if (v1 !== null && v2 !== null) {
                              avgVal = ((Math.round(((v1 + v2) / 2) * 10) / 10)).toString();
                            } else if (v1 !== null || v2 !== null) {
                              // One semester present. Try to estimate the missing semester using subjectMap totals
                              const subjMap = student.subjectMap && student.subjectMap[subj];
                              let estimatedOther = null;
                              if (subjMap && subjMap.totalEarned !== undefined) {
                                const combined = Number(subjMap.totalEarned || 0);
                                if (v1 !== null) {
                                  // estimate semester2 = combined - sem1
                                  estimatedOther = Math.max(0, combined - v1);
                                } else if (v2 !== null) {
                                  estimatedOther = Math.max(0, (Number(subjMap.totalEarned || 0) - v2));
                                }
                              }
                              const present = v1 !== null ? v1 : v2 as number;
                              if (estimatedOther !== null) {
                                avgVal = ((Math.round(((present + estimatedOther) / 2) * 10) / 10)).toString();
                              } else {
                                // fallback to present semester raw value or combined total
                                if (present !== null) avgVal = ((Math.round(present * 10) / 10)).toString();
                                else if (subjMap && subjMap.totalEarned !== undefined) avgVal = (Math.round((Number(subjMap.totalEarned || 0)) * 10) / 10).toString();
                              }
                            } else {
                              const subjMap = student.subjectMap && student.subjectMap[subj];
                              if (subjMap && subjMap.totalEarned !== undefined) {
                                avgVal = (Math.round((Number(subjMap.totalEarned || 0)) * 10) / 10).toString();
                              }
                            }
                            return <td key={subj} className="p-2 border text-center">{avgVal}</td>;
                          })}
                          {i === 0 || i === 1 ? (
                            <>
                              <td className="p-2 border text-center">{semTotals[i].possible > 0 ? `${semTotals[i].earned} / ${semTotals[i].possible}` : ''}</td>
                              <td className="p-2 border text-center">{semTotals[i].possible > 0 ? ((semTotals[i].earned / semTotals[i].possible) * 100).toFixed(1) + '%' : ''}</td>
                            </>
                          ) : (
                            <>
                              <td className="p-2 border text-center">{combined.possible > 0 ? `${combined.earned} / ${combined.possible}` : ''}</td>
                              <td className="p-2 border text-center">{combined.possible > 0 ? ((combined.earned / combined.possible) * 100).toFixed(1) + '%' : ''}</td>
                            </>
                          )}
                          {i === 0 && <td rowSpan={3} className="p-2 border text-center">{student.rank}</td>}
                          {i === 0 && <td rowSpan={3} className="p-2 border"></td>}
                          {i === 0 && <td rowSpan={3} className="p-2 border"></td>}
                        </tr>
                      );
                    })}
                  </>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  // Wrapper to prepare rankedStudents and subjects then call renderer
  const rosterWrapper = (classId?: string, gradeName?: string) => {
    const classes = Object.values(classStudentMap) as any[];
    const cls = classId ? classes.find(c => c.id === classId) : classes.find(c => (c.grade?.name || '') === (gradeName || selectedGrade));
    if (!cls) return null;
    const students = cls.students || [];
    const studentsWithAvg = students.map((student: any) => {
      const studentGrades = grades.filter(g => g.studentId === student.id && (!selectedAcademicYear || g.academicYear === selectedAcademicYear));
      const totalEarned = studentGrades.reduce((sum, g) => sum + (g.score || 0), 0);
      const totalPossible = studentGrades.reduce((sum, g) => sum + (g.maxScore || 0), 0);
      const avg = totalPossible > 0 ? (totalEarned / totalPossible) * 100 : 0;
      const subjectMap: Record<string, { totalEarned: number; totalPossible: number }> = {};
      studentGrades.forEach(g => {
        if (!subjectMap[g.subjectName]) subjectMap[g.subjectName] = { totalEarned: 0, totalPossible: 0 };
        subjectMap[g.subjectName].totalEarned += g.score || 0;
        subjectMap[g.subjectName].totalPossible += g.maxScore || 0;
      });
      return { ...student, totalEarned, totalPossible, avg, subjectMap };
    });
    studentsWithAvg.sort((a, b) => b.avg - a.avg || a.firstName.localeCompare(b.firstName));
    let lastAvg = null; let lastRank = 0; let actualRank = 0;
    const rankedStudents = studentsWithAvg.map(student => { actualRank++; if (lastAvg === student.avg) return { ...student, rank: lastRank }; lastAvg = student.avg; lastRank = actualRank; return { ...student, rank: lastRank }; });
    const allSubjects = Array.from(new Set(rankedStudents.flatMap(s => Object.keys(s.subjectMap))));
    return rosterInlineRenderer(rankedStudents, allSubjects as string[], gradeName || (cls.grade?.name || ''), (cls.section && cls.section.name) || cls.section || '', cls.name || '');
  };

  // Helper to render the admin summary with ranking and filtering
  const renderAdminSummary = () => {
    // Organize by grade and section using classStudentMap
    const gradeSectionMap: Record<string, Record<string, { className: string; students: any[] }>> = {};
    Object.values(classStudentMap).forEach((cls: any) => {
      const grade = cls.grade?.name || 'Unknown Grade';
      const section = cls.section?.name || 'Unknown Section';
      if (!gradeSectionMap[grade]) gradeSectionMap[grade] = {};
      if (!gradeSectionMap[grade][section]) gradeSectionMap[grade][section] = { className: cls.name, students: [] };
      // Filter by grade if selected
      if (selectedGrade && grade !== selectedGrade) return;
      gradeSectionMap[grade][section].students.push(...(cls.students || []));
    });

    // Helper: get all grades for a student, filtered by academic year and semester if selected
    const getStudentGrades = (studentId: string) => {
      return grades.filter(g => {
     if (g.studentId !== studentId) return false;
    if (selectedAcademicYear && g.academicYear !== selectedAcademicYear) {
      console.log('Filtered out by academicYear:', {
        gradeId: g.id,
        gAcademicYear: g.academicYear,
        selectedAcademicYear
      });
      return false;
    }
        // Allow semester filter to match by ID or name for robustness
        if (selectedSemester) {
          // g.semester may be ID or name, selectedSemester is always ID
          if (g.semester !== selectedSemester) {
            // Try to match by name if possible
            const semObj = semesters.find(s => s.id === selectedSemester);
            if (!semObj || g.semester !== semObj.name) {
              return false;
            }
          }
        }
        return true;
      });
    };

    // Inline roster renderer: mirrors the printed roster but displayed in the admin UI
    const renderInlineRoster = (rankedStudents: any[], allSubjects: string[], gradeName: string, sectionName: string, classNameStr: string) => {
      // Show roster once an academic year is selected. If a semester is also selected,
      // semester-specific columns will still render based on available grades.
      if (!selectedAcademicYear) return null;

      // Determine semester ids (prefer academic year's semesters)
      const academicYearObj = academicYears.find((y: any) => y.id === selectedAcademicYear) || null;
      const semDefs = (academicYearObj && academicYearObj.semesters && academicYearObj.semesters.length) ? academicYearObj.semesters : (semesters || []);
      const sem1Id = semDefs && semDefs.length > 0 ? (semDefs[0].id || semDefs[0].name) : 'I';
      const sem2Id = semDefs && semDefs.length > 1 ? (semDefs[1].id || semDefs[1].name) : 'II';
      const semIds = [sem1Id, sem2Id];
      const semLabels = ['I', 'II', 'Average of both semester'];

      const getTotalsLocal = (studentId: string | number, subject: string, semesterId?: string | number) => {
        const sidNorm = (studentId || '').toString().trim();
        const subjNorm = subject ? subject.toString().trim().toLowerCase() : '';
        const semNorm = semesterId !== undefined && semesterId !== null ? semesterId.toString().trim().toLowerCase() : '';
        const entries = grades.filter((g: any) => {
          try {
            const gStudent = (g.studentId || (g.student && g.student.id))?.toString().trim();
            if (!gStudent || gStudent !== sidNorm) return false;
            // subject match permissive
            if (subjNorm) {
              const candidates: string[] = [];
              if (g.subjectName) candidates.push((g.subjectName || '').toString().trim().toLowerCase());
              if (g.subjectId) candidates.push((g.subjectId || '').toString().trim().toLowerCase());
              if (g.subject && typeof g.subject === 'object') {
                if (g.subject.name) candidates.push((g.subject.name || '').toString().trim().toLowerCase());
                if (g.subject.id) candidates.push((g.subject.id || '').toString().trim().toLowerCase());
              }
              if (candidates.length > 0) {
                const match = candidates.some(c => c === subjNorm || c.includes(subjNorm) || subjNorm.includes(c));
                if (!match) return false;
              }
            }
            if (selectedAcademicYear) {
              const gAY = (g.academicYear || (g.class && g.class.academicYearId) || g.academicYearId)?.toString();
              if (gAY && gAY !== selectedAcademicYear && !(g.academicYear && g.academicYear.id && g.academicYear.id.toString() === selectedAcademicYear.toString())) return false;
            }
            if (semesterId !== undefined && semesterId !== null) {
              let gSem = g.semester;
              if (typeof gSem === 'object') gSem = gSem.id || gSem.name || '';
              const gSemStr = (gSem || g.semesterName || g.semesterId || '')?.toString().trim().toLowerCase();
              const targetSemStr = semNorm;
              if (gSemStr === targetSemStr) return true;
              // numeric/roman mapping
              const mapToNum = (v?: string) => {
                const t = (v || '').toString().trim().toLowerCase();
                if (['i', '1', 'first', 'one'].includes(t)) return 1;
                if (['ii', '2', 'second', 'two'].includes(t)) return 2;
                return null;
              };
              const gNum = mapToNum(gSemStr);
              const tNum = mapToNum(targetSemStr);
              if (gNum && tNum && gNum === tNum) return true;
              return false;
            }
            return true;
          } catch (err) {
            return false;
          }
        });
        const totalEarned = entries.reduce((s: number, e: any) => s + (Number(e.score ?? e.pointsEarned ?? 0)), 0);
        const totalPossible = entries.reduce((s: number, e: any) => s + (Number(e.maxScore ?? e.totalPoints ?? 0)), 0);
        return { totalEarned, totalPossible };
      };

      return (
        <div className="mb-4">
          <h6 className="text-sm font-semibold mb-2">Roster View ({gradeName} - {sectionName})</h6>
          <div className="overflow-x-auto">
            <table className="w-full border text-sm">
              <thead>
                <tr className="bg-gray-50">
                  <th className="p-2 border">R N o.</th>
                  <th className="p-2 border">Student</th>
                  <th className="p-2 border">Email</th>
                  <th className="p-2 border">Sex</th>
                  <th className="p-2 border">Age</th>
                  <th className="p-2 border">Semester</th>
                  {allSubjects.map(sub => <th key={sub} className="p-2 border text-center">{sub}</th>)}
                  <th className="p-2 border">Total</th>
                  <th className="p-2 border">Average</th>
                  <th className="p-2 border">Rank</th>
                  <th className="p-2 border">Cond</th>
                  <th className="p-2 border">Attn</th>
                </tr>
              </thead>
              <tbody>
                {rankedStudents.map((student: any, idx: number) => {
                  // compute semester totals for trailing columns
                  const semTotals = semIds.map((sId) => {
                    const tAll = allSubjects.reduce((acc, subj) => {
                      const t = getTotalsLocal(student.id, subj, sId) || { totalEarned: 0, totalPossible: 0 };
                      return { earned: acc.earned + (t.totalEarned || 0), possible: acc.possible + (t.totalPossible || 0) };
                    }, { earned: 0, possible: 0 });
                    return tAll;
                  });
                  const combined = { earned: (semTotals[0]?.earned || 0) + (semTotals[1]?.earned || 0), possible: (semTotals[0]?.possible || 0) + (semTotals[1]?.possible || 0) };
                  return (
                    <>
                      {[0,1,2].map(i => {
                        return (
                          <tr key={`${student.id}-${i}`} className="border hover:bg-gray-50">
                            {i === 0 && (
                              <>
                                <td rowSpan={3} className="p-2 border align-middle text-center">{idx + 1}</td>
                                <td rowSpan={3} className="p-2 border align-middle">{`${student.firstName || ''} ${(student.fatherName || student.lastName) || ''} ${student.grandFatherName || ''}`.trim()}</td>
                                <td rowSpan={3} className="p-2 border align-middle">{student.email || ''}</td>
                                <td rowSpan={3} className="p-2 border align-middle text-center">{student.gender || ''}</td>
                                <td rowSpan={3} className="p-2 border align-middle text-center">{student.age || ''}</td>
                              </>
                            )}
                            <td className="p-2 border text-center">{semLabels[i]}</td>
                            {allSubjects.map(subj => {
                              if (i === 0 || i === 1) {
                                const semId = semIds[i];
                                const t = getTotalsLocal(student.id, subj, semId) || { totalEarned: 0, totalPossible: 0 };
                                const cell = (t && (t.totalEarned || t.totalEarned === 0)) ? `${t.totalEarned}` : '-';
                                return <td key={subj} className="p-2 border text-center">{cell}</td>;
                              }
                              // AV row
                              const t1 = getTotalsLocal(student.id, subj, semIds[0]) || null;
                              const t2 = getTotalsLocal(student.id, subj, semIds[1]) || null;
                              const v1 = (t1 && (t1.totalEarned || t1.totalEarned === 0)) ? Number(t1.totalEarned) : null;
                              const v2 = (t2 && (t2.totalEarned || t2.totalEarned === 0)) ? Number(t2.totalEarned) : null;
                              let avgVal = '-';
                              if (v1 !== null && v2 !== null) {
                                avgVal = ((Math.round(((v1 + v2) / 2) * 10) / 10)).toString();
                              } else if (v1 !== null) {
                                avgVal = (Math.round(v1 * 10) / 10).toString();
                              } else if (v2 !== null) {
                                avgVal = (Math.round(v2 * 10) / 10).toString();
                              } else {
                                const subjMap = student.subjectMap && student.subjectMap[subj];
                                if (subjMap && subjMap.totalEarned !== undefined) {
                                  avgVal = (Math.round((Number(subjMap.totalEarned || 0)) * 10) / 10).toString();
                                }
                              }
                              return <td key={subj} className="p-2 border text-center">{avgVal}</td>;
                            })}
                            {i === 0 || i === 1 ? (
                              <>
                                <td className="p-2 border text-center">{semTotals[i].possible > 0 ? `${semTotals[i].earned} / ${semTotals[i].possible}` : ''}</td>
                                <td className="p-2 border text-center">{semTotals[i].possible > 0 ? ((semTotals[i].earned / semTotals[i].possible) * 100).toFixed(1) + '%' : ''}</td>
                              </>
                            ) : (
                              <>
                                <td className="p-2 border text-center">{combined.possible > 0 ? `${combined.earned} / ${combined.possible}` : ''}</td>
                                <td className="p-2 border text-center">{combined.possible > 0 ? ((combined.earned / combined.possible) * 100).toFixed(1) + '%' : ''}</td>
                              </>
                            )}
                            {i === 0 && <td rowSpan={3} className="p-2 border text-center">{student.rank}</td>}
                            {i === 0 && <td rowSpan={3} className="p-2 border"></td>}
                            {i === 0 && <td rowSpan={3} className="p-2 border"></td>}
                          </tr>
                        );
                      })}
                    </>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    // (removed duplicate renderRosterJSX)

    if (Object.keys(gradeSectionMap).length === 0) {
      return <div className="text-gray-500">No student/class data available.</div>;
    }

    return (
      <div className="space-y-8">
        <div className="flex flex-wrap gap-4 items-end mb-2">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
            <select
              className="border rounded px-2 py-1 text-sm w-48"
              value={selectedAcademicYear}
              onChange={e => { setSelectedAcademicYear(e.target.value); setSelectedSemester(''); }}
            >
              <option value="">All</option>
              {academicYears && academicYears.length > 0
                ? academicYears.map(year => (
                    <option key={year.id} value={year.id}>{year.name}</option>
                  ))
                : null}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Semester</label>
            <select
              className="border rounded px-2 py-1 text-sm w-48"
              value={selectedSemester}
              onChange={e => setSelectedSemester(e.target.value)}
            >bd
              <option value="">All</option>
              {semesters && semesters.length > 0
                ? semesters.map(sem => (
                    <option key={sem.id} value={sem.id}>{sem.name}</option>
                  ))
                : null}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Grade</label>
            <select
              className="border rounded px-2 py-1 text-sm"
              value={selectedGrade}
              onChange={e => setSelectedGrade(e.target.value)}
            >
              <option value="">All</option>
              {Object.keys(classStudentMap).map(cid => classStudentMap[cid]?.grade?.name).filter(Boolean).filter((v, i, a) => a.indexOf(v) === i).sort().map(grade => (
                <option key={grade} value={grade}>{grade}</option>
              ))}
            </select>
          </div>
          <Button onClick={exportAllSectionsToExcel} variant="outline" size="sm">
            Export All Classes to Excel
          </Button>
          <Button variant="outline" size="sm" onClick={() => {
            // Print roster(s) for selected grade
            if (!selectedGrade) {
              toast.error('Please select a Grade to print roster for.');
              return;
            }
            // find classes matching selected grade
            const classEntries = (Object.values(classStudentMap) as any[]).filter((c: any) => (c.grade?.name || '').toString() === selectedGrade.toString());
            if (classEntries.length === 0) {
              toast.error('No classes found for selected grade.');
              return;
            }
            for (const cls of classEntries) {
              const students = cls.students || [];
              // collect subjects for this class from grades
              const allSubjects = Array.from(new Set(grades.filter((g: any) => g.classId === cls.id).map((g: any) => g.subjectName).filter(Boolean)));
              handlePrintRoster(students, selectedGrade, cls.section?.name || cls.section || '', cls.name, allSubjects.length ? allSubjects : ['Subject']);
            }
          }}>
            Print Roster
          </Button>
        </div>
        {Object.entries(gradeSectionMap).sort(([a], [b]) => a.localeCompare(b)).map(([grade, sectionMap]) => (
          <div key={grade} className="space-y-6">
            <h3 className="text-xl font-bold">{grade}</h3>
            {Object.entries(sectionMap).sort(([a], [b]) => a.localeCompare(b)).map(([section, { className, students }]) => {
              // Compute average for each student and sort for ranking
              // Use all students returned by the backend for the class (already filtered by academic year)
              const studentsWithAvg = students.map((student: any) => {
                const studentGrades = getStudentGrades(student.id);
                const totalEarned = studentGrades.reduce((sum, g) => sum + (g.score || 0), 0);
                const totalPossible = studentGrades.reduce((sum, g) => sum + (g.maxScore || 0), 0);
                const avg = totalPossible > 0 ? (totalEarned / totalPossible) * 100 : 0;
                // Subject-wise breakdown
                const subjectMap: Record<string, { totalEarned: number; totalPossible: number }> = {};
                studentGrades.forEach(g => {
                  if (!subjectMap[g.subjectName]) subjectMap[g.subjectName] = { totalEarned: 0, totalPossible: 0 };
                  subjectMap[g.subjectName].totalEarned += g.score || 0;
                  subjectMap[g.subjectName].totalPossible += g.maxScore || 0;
                });
                // Attach academicYear and semester for printout
                let academicYear = '';
                let semester = '';
                if (studentGrades.length > 0) {
                  academicYear = studentGrades[0].academicYear || '';
                  // Try to display semester name if possible
                  const semId = studentGrades[0].semester;
                  const semObj = semesters.find(s => s.id === semId);
                  semester = semObj ? semObj.name : semId || '';
                }
                return { ...student, totalEarned, totalPossible, avg, subjectMap, academicYear, semester };
              });
              // Sort by avg descending, then by name for tie-breaker
              studentsWithAvg.sort((a, b) => b.avg - a.avg || a.firstName.localeCompare(b.firstName));
              // Assign ranks with ties (same avg = same rank, skip numbers)
              let lastAvg = null;
              let lastRank = 0;
              let actualRank = 0;
              const rankedStudents = studentsWithAvg.map((student, idx) => {
                actualRank++;
                if (lastAvg === student.avg) {
                  // same as previous, same rank
                  return { ...student, rank: lastRank };
                } else {
                  lastAvg = student.avg;
                  lastRank = actualRank;
                  return { ...student, rank: lastRank };
                }
              });
              // Collect all unique subjects for this section for consistent print/export order
              const allSubjects = Array.from(new Set(rankedStudents.flatMap(s => Object.keys(s.subjectMap))));
              return (
                <div key={section} className="space-y-4 ml-4">
                  <div className="flex flex-wrap gap-2 justify-end mb-2">
                    <Button onClick={() => exportSectionToExcel(grade, section, className, rankedStudents)} variant="outline" size="sm">
                      Export to Excel
                    </Button>
                    <Button variant="outline" size="sm" onClick={() => handleBatchPrintStudentReports(rankedStudents, grade, section, className, allSubjects, rankedStudents)}>
                      Print All Student Reports
                    </Button>
                    <Button variant="outline" size="sm" onClick={() => handleBatchSaveStudentReportsAsPDF(rankedStudents, grade, section, className, allSubjects, rankedStudents)}>
                      Save All as PDF
                    </Button>
                    <Button variant="outline" size="sm" onClick={() => handlePrintRoster(rankedStudents, grade, section, className, allSubjects)}>
                      Print Roster
                    </Button>
                  </div>
                  <h4 className="text-lg font-semibold">Section {section} ({className})</h4>
                  <div className="overflow-x-auto">
                    {/* Admin quick summary table: Name, Total, Average, Rank (no print button) */}
                    <div className="mb-4">
                      <h6 className="text-sm font-semibold mb-2">Quick Student Summary</h6>
                      <table className="w-full border">
                        <thead>
                          <tr className="bg-gray-50">
                            <th className="p-2 text-left border">Student</th>
                            <th className="p-2 text-left border">Total Score</th>
                            <th className="p-2 text-left border">Average (%)</th>
                            <th className="p-2 text-left border">Rank</th>
                          </tr>
                        </thead>
                        <tbody>
                          {rankedStudents.map(student => (
                            <tr key={student.id} className="border hover:bg-gray-50">
                              <td className="p-2 border">{student.firstName} {student.lastName}</td>
                              <td className="p-2 border">{student.totalEarned} / {student.totalPossible}</td>
                              <td className="p-2 border">{student.avg.toFixed(1)}%</td>
                              <td className="p-2 border">{student.rank}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                      <br/>
                      <h6 className="text-sm font-semibold mb-2">Detailed Student Summary</h6>
                      {/* Inline roster view (appears when Academic Year selected) - placed above the detailed table for visibility */}
                      {rosterWrapper(undefined, grade)}
                    <div className="flex justify-end mb-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => printDetailedTable(rankedStudents, allSubjects, grade, section, className)}
                      >
                        Print Detailed Table
                      </Button>
                    </div>
                    <table className="w-full border">
                      <thead>
                        <tr className="bg-blue-100">
                          <th className="p-2 text-left border">Student</th>
                          <th className="p-2 text-left border">Email</th>
                          {/* Dynamically render subject columns: subject name as column */}
                          {allSubjects.map(subject => (
                            <th key={subject} className="p-2 text-left border">{subject}</th>
                          ))}
                          <th className="p-2 text-left border">Total Score</th>
                          <th className="p-2 text-left border">Average (%)</th>
                          <th className="p-2 text-left border">Rank</th>
                          <th className="p-2 text-left border">Print</th>
                        </tr>
                      </thead>
                      <tbody>
                        {rankedStudents.map((student) => (
                          <tr key={student.id} className="border hover:bg-gray-50">
                            <td className="p-2 border">{`${student.firstName || ''} ${(student.fatherName || student.lastName) || ''} ${student.grandFatherName || ''}`.trim()}</td>
                            <td className="p-2 border">{student.email}</td>
                            
                            {allSubjects.map(subject => {
                              const subj = student.subjectMap[subject];
                              console.log(`AdminSummary: grade=${grade}, section=${section}, rankedStudents=`, rankedStudents);

                              return (
                                <td key={subject} className="p-2 border">{subj ? `${subj.totalEarned} / ${subj.totalPossible}` : '-'}</td>
                              );
                            })}
                            <td className="p-2 border">{student.totalEarned} / {student.totalPossible}</td>
                            <td className="p-2 border">{student.avg.toFixed(1)}%</td>
                            <td className="p-2 border">{student.rank}</td>
                            <td className="p-2 border">
                              <Button
                                variant="outline"
                                size="sm"
                                title="Print Student Report"
                                onClick={() => handlePrintStudentReport(student, grade, section, className, allSubjects, rankedStudents)}
                                className="flex items-center gap-1"
                              >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2m-6 0v4m0 0h4m-4 0H8" /></svg>
                                <span className="hidden md:inline">Print</span>
                              </Button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              );
            })}
          </div>
        ))}
      </div>
      
    );
  };
  const { user } = useAuth();
  const [activeTab, setActiveTab] = useState('subjects');
  const [subjects, setSubjects] = useState<Subject[]>([]);
  const [grades, setGrades] = useState<Grade[]>([]);
  const [exams, setExams] = useState<Exam[]>([]);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [dialogType, setDialogType] = useState<'subject' | 'grade' | 'exam'>('subject');
  const [selectedItem, setSelectedItem] = useState<any>(null);
  const [isEditing, setIsEditing] = useState(false);
  const [classStudentMap, setClassStudentMap] = useState<any>({});
  const [selectedSectionId, setSelectedSectionId] = useState<string>('');

  const gradesList = ['grade-9', 'grade-10', 'grade-11', 'grade-12'];
  const sections = ['A', 'B', 'C'];
  // Removed duplicate semesters declaration to avoid redeclaration error

  // Replace mock data with real API calls
  useEffect(() => {
    const fetchData = async () => {
      try {
         const params: any = {};
      if (selectedAcademicYear && selectedAcademicYear !== "ALL") {
        params.academicYearId = selectedAcademicYear;
      }
        const [subjects, gradesRaw, exams, classes] = await Promise.all([
          getSubjects(),
          getGrades(params),
          getExams(),
          getClasses(),
        ]);
        setSubjects(subjects);
        setExams(exams);

              console.log('gradesRaw from backend:', gradesRaw);

              
        // Map backend grades to frontend shape, always use academicYear and semester as IDs
        const grades = gradesRaw.map((g: any) => {

          const score = g.pointsEarned ?? g.score ?? 0;
          const maxScore = g.totalPoints ?? g.maxScore ?? 0;
          const percentage = maxScore > 0 ? (score / maxScore) * 100 : 0;
          const gradeLevel = g.class?.grade?.name || (g.className ? g.className.split(' ')[0] : undefined);
          const section = g.class?.section?.name || (g.className ? g.className.split(' ')[1] : undefined);
          // Normalize academicYear to id string for filtering
         let academicYearId = '';
  if (g.class && g.class.academicYearId) {
    academicYearId = g.class.academicYearId;
  } else if (g.class && g.class.academicYear && g.class.academicYear.id) {
    academicYearId = g.class.academicYear.id;
  } else if (g.academicYearId) {
    academicYearId = g.academicYearId;
  } else if (typeof g.academicYear === 'string') {
    academicYearId = g.academicYear;
  }
          // Normalize semester to id string for filtering
          let semesterId = '';
          if (g.semester && typeof g.semester === 'object' && g.semester.id) {
            semesterId = g.semester.id;
          } else if (typeof g.semester === 'string') {
            semesterId = g.semester;
          }
          return {
            id: g.id,
            studentId: g.studentId,
            studentName: g.student ? `${g.student.firstName} ${g.student.lastName}` : '',
            subjectId: g.subjectId,
            subjectName: g.subject ? g.subject.name : '',
            examType: g.category ? g.category.name : '',
            score,
            maxScore,
            percentage,
            grade: getLetterGrade(percentage),
            date: g.date ? new Date(g.date).toLocaleDateString() : '',
            semester: semesterId,
            remarks: g.remarks || '',
            className: g.className,
            gradeLevel,
            section,
            classId: g.class?.id || g.classId,
            academicYear: academicYearId,
          };
        });
              console.log('Mapped grades for UI:', grades);

        setGrades(grades);
        

        // Fetch students for each class, filtered by selected academic year and semester if set
      const classStudentMap: any = {};
      await Promise.all(classes.map(async (cls: any) => {
        // Always pass academicYearId and semesterId if set
        const params: any = {};
        if (selectedAcademicYear) params.academicYearId = selectedAcademicYear;
        if (selectedSemester) params.semesterId = selectedSemester;
        const students = await getStudentsByClass(cls.id, Object.keys(params).length ? params : undefined);
        // Ensure section is included and has a name
        let section = cls.section || cls.classSection || cls.classSectionId || null;
        // If section is an object, prefer its name
        let sectionObj = section && typeof section === 'object' ? section : null;
        let sectionName = sectionObj && sectionObj.name ? sectionObj.name : (typeof section === 'string' ? section : undefined);
        classStudentMap[cls.id] = {
          ...cls,
          students,
          section: sectionObj ? sectionObj : (sectionName ? { name: sectionName } : undefined),
        };
      }));
      console.log('classStudentMap:', classStudentMap);

        setClassStudentMap(classStudentMap);
      } catch (e) {
        toast.error('Failed to load academic data');
      }
    };
    fetchData();
    // Re-fetch students when academic year or semester filter changes
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedAcademicYear, selectedSemester]);

  // Print Detailed Table function (top-level, only one definition)
  // Updated: Print each student's detailed report individually (one per page, in a single print job)
  function printDetailedTable(rankedStudents: any[], allSubjects: string[], grade: string, section: string, className: string) {
    // Reuse the same layout as handlePrintStudentReport, but for all students, each on a new page
    const schoolName = "SSPS";
    let content = '';
    rankedStudents.forEach(student => {
      // Calculate percentile for this student
      const avgs = rankedStudents.map(s => s.avg).sort((a, b) => a - b);
      let percentile = '100';
      if (avgs.length > 1) {
        const below = avgs.filter(a => a < student.avg).length;
        const equal = avgs.filter(a => a === student.avg).length;
        percentile = (((below + 0.5 * equal) / avgs.length) * 100).toFixed(1);
      }
      // Student info block
      const infoRows = [
        { label: 'Name', value: `${student.firstName} ${student.lastName}` },
        { label: 'Email', value: student.email },
        { label: 'Grade', value: grade },
        { label: 'Section', value: section },
        { label: 'Class', value: className },
        { label: 'Academic Year', value: student.academicYear || '-' },
        { label: 'Semester', value: student.semester || '-' },
        { label: 'Date', value: new Date().toLocaleDateString() },
      ];
      // Subject scores table
      let subjectRows = '';
      allSubjects.forEach(subject => {
        const subj = student.subjectMap[subject];
        subjectRows += `<tr>
          <td style='padding:6px 12px;border:1px solid #e0e0e0;background:#f9fafb;'>${subject}</td>
          <td style='padding:6px 12px;border:1px solid #e0e0e0;text-align:center;'>${subj ? subj.totalEarned : ''} / ${subj ? subj.totalPossible : ''}</td>
          <td style='padding:6px 12px;border:1px solid #e0e0e0;text-align:center;'>${subj && subj.totalPossible > 0 ? ((subj.totalEarned / subj.totalPossible) * 100).toFixed(1) + '%' : ''}</td>
        </tr>`;
      });
      // Summary block
      const summaryRows = [
        { label: 'Total Score', value: `${student.totalEarned} / ${student.totalPossible}` },
        { label: 'Average (%)', value: `${student.avg.toFixed(1)}%` },
        { label: 'Rank', value: student.rank },
        { label: 'Percentile', value: percentile },
        { label: 'Grade', value: getLetterGrade(student.avg) },
      ];
      content += `
        <div style='max-width:700px;margin:32px auto;padding:32px 40px 32px 40px;background:#fff;border-radius:12px;box-shadow:0 2px 16px #0001;font-family:sans-serif;page-break-after: always;'>
          <div style='text-align:center;margin-bottom:24px;'>
            <h2 style='margin:0;font-size:2rem;font-weight:700;color:#1a237e;'>${schoolName}</h2>
            <h3 style='margin:0;font-size:1.2rem;font-weight:500;color:#333;'>Student Academic Report</h3>
          </div>
          <div style='display:flex;gap:32px;justify-content:space-between;flex-wrap:wrap;margin-bottom:32px;'>
            <div style='flex:1 1 220px;'>
              <h4 style='margin:0 0 8px 0;font-size:1.05rem;color:#1976d2;'>Student Information</h4>
              <table style='width:100%;border-collapse:collapse;'>
                ${infoRows.map(row => `<tr><td style='padding:4px 0 4px 0;color:#555;font-weight:500;width:120px;'>${row.label}:</td><td style='padding:4px 0 4px 0;color:#222;'>${row.value}</td></tr>`).join('')}
              </table>
            </div>
            <div style='flex:1 1 220px;'>
              <h4 style='margin:0 0 8px 0;font-size:1.05rem;color:#1976d2;'>Summary</h4>
              <table style='width:100%;border-collapse:collapse;'>
                ${summaryRows.map(row => `<tr><td style='padding:4px 0 4px 0;color:#555;font-weight:500;width:120px;'>${row.label}:</td><td style='padding:4px 0 4px 0;color:#222;'>${row.value}</td></tr>`).join('')}
              </table>
            </div>
          </div>
          <div style='margin-bottom:24px;'>
            <h4 style='margin:0 0 8px 0;font-size:1.05rem;color:#1976d2;'>Subject Scores</h4>
            <table style='width:100%;border-collapse:collapse;margin-bottom:0;'>
              <thead>
                <tr style='background:#f5f5f5;'>
                  <th style='padding:6px 12px;border:1px solid #e0e0e0;text-align:left;'>Subject</th>
                  <th style='padding:6px 12px;border:1px solid #e0e0e0;text-align:center;'>Score</th>
                  <th style='padding:6px 12px;border:1px solid #e0e0e0;text-align:center;'>Percentage</th>
                </tr>
              </thead>
              <tbody>
                ${subjectRows}
              </tbody>
            </table>
          </div>
          <div style='margin-top:32px;text-align:center;font-size:12px;color:#888;'>Generated by Sawla SMIS</div>
        </div>
      `;
    });
    const printWindow = window.open('', '', 'width=900,height=1000');
    if (!printWindow) return;
    printWindow.document.write(`
      <html><head><title>All Student Reports</title>
      <style>
        @media print {
          div[style*='page-break-after'] { page-break-after: always; }
          body { background: #fff !important; }
        }
      </style>
      </head><body style='background:#f5f7fa;font-family:sans-serif;'>
        ${content}
        <script>window.onload = function() { window.print(); }</script>
      </body></html>
    `);
    printWindow.document.close();
  }

  const handleCreate = (type: 'subject' | 'grade' | 'exam') => {
    setDialogType(type);
    setSelectedItem(null);
    setIsEditing(false);
    setIsDialogOpen(true);
  };

  const handleEdit = (type: 'subject' | 'grade' | 'exam', item: any) => {
    setDialogType(type);
    setSelectedItem(item);
    setIsEditing(true);
    setIsDialogOpen(true);
  };

  const handleDelete = (type: 'subject' | 'grade' | 'exam', id: string) => {
    switch (type) {
      case 'subject':
        setSubjects(subjects.filter(s => s.id !== id));
        break;
      case 'grade':
        setGrades(grades.filter(g => g.id !== id));
        break;
      case 'exam':
        setExams(exams.filter(e => e.id !== id));
        break;
    }
    toast.success(`${type} deleted successfully`);
  };

  const handleSave = async (type: 'subject' | 'grade' | 'exam', data: any) => {
    const newId = Date.now().toString();
    
    switch (type) {
      case 'subject':
        try {
          if (isEditing && selectedItem) {
            const updatedSubject = await updateSubject(selectedItem.id, data);
            setSubjects(subjects.map(s => s.id === updatedSubject.id ? updatedSubject : s));
          } else {
            const createdSubject = await createSubject({ id: newId, ...data });
            setSubjects([...subjects, createdSubject]);
          }
          toast.success(`Subject ${isEditing ? 'updated' : 'created'} successfully`);
        } catch (error) {
          toast.error('Failed to save subject');
        }
        break;
      case 'grade':
        const percentage = (data.score / data.maxScore) * 100;
        const gradeData = {
          ...data,
          percentage,
          grade: getLetterGrade(percentage),
        };
        try {
          if (isEditing && selectedItem) {
            const updatedGrade = await updateGrade(selectedItem.id, gradeData);
            setGrades(grades.map(g => g.id === updatedGrade.id ? updatedGrade : g));
          } else {
            const createdGrade = await createGrade({ id: newId, ...gradeData });
            setGrades([...grades, createdGrade]);
          }
          toast.success(`Grade ${isEditing ? 'updated' : 'created'} successfully`);
        } catch (error) {
          toast.error('Failed to save grade');
        }
        break;
      case 'exam':
        try {
          if (isEditing && selectedItem) {
            const updatedExam = await updateExam(selectedItem.id, data);
            setExams(exams.map(e => e.id === updatedExam.id ? updatedExam : e));
          } else {
            const createdExam = await createExam({ id: newId, ...data, status: 'scheduled' });
            setExams([...exams, createdExam]);
          }
          toast.success(`Exam ${isEditing ? 'updated' : 'created'} successfully`);
        } catch (error) {
          toast.error('Failed to save exam');
        }
        break;
    }
    
    setIsDialogOpen(false);
  };

  if (user?.role !== 'admin' && user?.role !== 'teacher') {
    return (
      <div className="p-6 text-center">
        <h1 className="text-2xl font-bold text-red-600">Access Denied</h1>
        <p className="text-gray-600 mt-2">You don't have permission to manage academics.</p>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Academic Management</h1>
          <p className="text-gray-600">Manage subjects, grades, and examinations</p>
        </div>
      </div>

      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="grid w-full grid-cols-6">
          <TabsTrigger value="subjects">Subjects</TabsTrigger>
          <TabsTrigger value="all-grades">All Grades</TabsTrigger>
          <TabsTrigger value="exams">Examinations</TabsTrigger>
          <TabsTrigger value="academic-years">Academic Years</TabsTrigger>
          <TabsTrigger value="roster">Roster</TabsTrigger>
        </TabsList> 
        <TabsContent value="subjects" className="space-y-4">
          <SubjectManagement />
        </TabsContent>

        <TabsContent value="grades" className="space-y-4">
          {/* Show Admin summary above GradeManagement for admin only (removed broken AdminStudentSummary) */}
          <GradeManagement />
        </TabsContent>

{/* // In your AcademicManagement component, update the all-grades tab content: */}
        <TabsContent value="all-grades" className="space-y-4">
          {user?.role === 'admin' && (
            <Card className="mb-6">
              <CardHeader>
                <CardTitle>Student Academic Summary</CardTitle>
              </CardHeader>
              <CardContent>
                {renderAdminSummary()}
              </CardContent>
            </Card>
          )}
        </TabsContent>

        <TabsContent value="exams" className="space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="text-xl font-semibold">Examination Management</h2>
            <Button onClick={() => handleCreate('exam')}>
              <Plus className="w-4 h-4 mr-2" />
              Schedule Exam
            </Button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {exams.map((exam) => (
              <Card key={exam.id}>
                <CardHeader>
                  <CardTitle className="flex items-center justify-between">
                    <div className="flex items-center space-x-2">
                      <FileText className="w-5 h-5" />
                      <span className="text-sm">{exam.title}</span>
                    </div>
                    <Badge variant={
                      exam.status === 'completed' ? 'default' :
                      exam.status === 'ongoing' ? 'secondary' : 'outline'
                    }>
                      {exam.status}
                    </Badge>
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2">
                    <p><strong>Subject:</strong> {exam.subjectName}</p>
                    <p><strong>Grade:</strong> {exam.grade.replace('-', ' ').toUpperCase()} - {exam.section}</p>
                    <p><strong>Type:</strong> {exam.type}</p>
                    <p><strong>Date:</strong> {exam.date}</p>
                    <p><strong>Duration:</strong> {exam.duration} minutes</p>
                    <p><strong>Max Score:</strong> {exam.maxScore}</p>
                    {exam.instructions && (
                      <p className="text-sm text-gray-600"><strong>Instructions:</strong> {exam.instructions}</p>
                    )}
                    <div className="flex space-x-2 mt-4">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => handleEdit('exam', exam)}
                      >
                        <Edit className="w-3 h-3" />
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => handleDelete('exam', exam.id)}
                        className="text-red-600"
                      >
                        <Trash2 className="w-3 h-3" />
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </TabsContent>

        <TabsContent value="academic-years" className="space-y-4">
          <AcademicYearManagement />
        </TabsContent>
        <TabsContent value="roster" className="space-y-4">
          {user?.role === 'admin' && (
            <Card>
              <CardHeader>
                <CardTitle>Roster View</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="flex flex-wrap gap-4 items-end mb-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                    <select
                      className="border rounded px-2 py-1 text-sm w-48"
                      value={selectedAcademicYear}
                      onChange={e => { setSelectedAcademicYear(e.target.value); setSelectedSemester(''); }}
                    >
                      <option value="">Select year</option>
                      {academicYears && academicYears.length > 0
                        ? academicYears.map((year: any) => (
                            <option key={year.id} value={year.id}>{year.name}</option>
                          ))
                        : null}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Grade</label>
                    <select className="border rounded px-2 py-1 text-sm w-48" value={selectedGrade} onChange={e => setSelectedGrade(e.target.value)}>
                      <option value="">Select grade</option>
                      {Array.from(new Set(Object.values(classStudentMap).map((c: any) => c.grade?.name).filter(Boolean))).map((g: any) => (
                        <option key={g} value={g}>{g}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Section</label>
                    {/* Populate sections for the selected grade and include an 'All sections' option */}
                    <select
                      className="border rounded px-2 py-1 text-sm w-48"
                      value={selectedSectionId}
                      onChange={(e) => setSelectedSectionId(e.target.value)}
                    >
                      <option value="">Select section (pick grade first)</option>
                      {selectedGrade && (() => {
                        const classesForGrade = (Object.values(classStudentMap) as any[]).filter(c => (c.grade?.name || '') === selectedGrade);
                        if (classesForGrade.length === 0) return null;
                        return (
                          <>
                            <option value="ALL">All sections</option>
                            {classesForGrade.map(c => (
                              <option key={c.id} value={c.id}>{c.section?.name || c.section || c.name}</option>
                            ))}
                          </>
                        );
                      })()}
                    </select>
                  </div>
                </div>
                {/* If grade selected, show per-section options and roster for the selected section */}
                {selectedAcademicYear && selectedGrade && (
                  (() => {
                    // build sections list for selected grade
                    const classesForGrade = (Object.values(classStudentMap) as any[]).filter(c => (c.grade?.name || '') === selectedGrade);
                    const sections = classesForGrade.map(c => ({ id: c.id, name: c.section?.name || c.section || c.name }));
                    return (
                      <div>
                        <div className="mb-2">
                          <label className="block text-sm font-medium text-gray-700 mb-1">Choose section</label>
                          <div className="flex gap-2 flex-wrap">
                            <Button key="all-sections" variant={selectedSectionId === 'ALL' ? 'default' : 'outline'} size="sm" onClick={() => { setSelectedSectionId('ALL'); }}>
                              All sections
                            </Button>
                            {sections.map(s => (
                              <Button key={s.id} variant={s.id === selectedSectionId ? 'default' : 'outline'} size="sm" onClick={() => { setSelectedSectionId(s.id); }}>
                                {s.name}
                              </Button>
                            ))}
                          </div>
                        </div>
                        {/* Render roster(s) for selected section or all sections */}
                        {sections.length > 0 && (() => {
                          if (selectedSectionId === 'ALL') {
                            // render each section's roster one after another
                            return classesForGrade.map(c => (
                              <div key={c.id} className="mb-6">
                                {rosterWrapper(c.id, selectedGrade)}
                              </div>
                            ));
                          }
                          const cls = selectedSectionId ? classesForGrade.find(c => c.id === selectedSectionId) : classesForGrade.find(c => true) as any;
                          return rosterWrapper(cls?.id, selectedGrade);
                        })()}
                      </div>
                    );
                  })()
                )}
              </CardContent>
            </Card>
          )}
        </TabsContent>
      </Tabs>

      <AcademicDialog
        isOpen={isDialogOpen}
        onClose={() => setIsDialogOpen(false)}
        type={dialogType}
        item={selectedItem}
        onSave={handleSave}
        isEditing={isEditing}
        subjects={subjects}
        gradesList={gradesList}
        sections={sections}
        semesters={semesters.map((s: any) => s.name)}
      />
    </div>
  );
};

interface AcademicDialogProps {
  isOpen: boolean;
  onClose: () => void;
  type: 'subject' | 'grade' | 'exam';
  item: any;
  onSave: (type: 'subject' | 'grade' | 'exam', data: any) => void;
  isEditing: boolean;
  subjects: Subject[];
  gradesList: string[];
  sections: string[];
  semesters: string[];
}

const AcademicDialog = ({ isOpen, onClose, type, item, onSave, isEditing, subjects, gradesList, sections, semesters }: AcademicDialogProps) => {
  const [formData, setFormData] = useState<any>({});

  useEffect(() => {
    if (item) {
      setFormData(item);
    } else {
      setFormData({});
    }
  }, [item]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onSave(type, formData);
    setFormData({});
  };

  const getDialogTitle = () => {
    const action = isEditing ? 'Edit' : 'Create';
    switch (type) {
      case 'subject': return `${action} Subject`;
      case 'grade': return `${action} Grade`;
      case 'exam': return `${action} Exam`;
      default: return action;
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>{getDialogTitle()}</DialogTitle>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          {type === 'subject' && (
            <>
              <div>
                <Label htmlFor="name">Subject Name</Label>
                <Input
                  id="name"
                  value={formData.name || ''}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label htmlFor="code">Subject Code</Label>
                <Input
                  id="code"
                  value={formData.code || ''}
                  onChange={(e) => setFormData({ ...formData, code: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label htmlFor="grade">Grade</Label>
                <Select
                  value={formData.grade || ''}
                  onValueChange={(value) => setFormData({ ...formData, grade: value })}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select grade" />
                  </SelectTrigger>
                  <SelectContent>
                    {gradesList.map(grade => (
                      <SelectItem key={grade} value={grade}>
                        {grade.replace('-', ' ').toUpperCase()}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label htmlFor="credits">Credits</Label>
                <Input
                  id="credits"
                  type="number"
                  value={formData.credits || ''}
                  onChange={(e) => setFormData({ ...formData, credits: parseInt(e.target.value) })}
                  required
                />
              </div>
              <div>
                <Label htmlFor="description">Description</Label>
                <Textarea
                  id="description"
                  value={formData.description || ''}
                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                />
              </div>
            </>
          )}

          {type === 'grade' && (
            <>
              <div>
                <Label htmlFor="studentName">Student Name</Label>
                <Input
                  id="studentName"
                  value={formData.studentName || ''}
                  onChange={(e) => setFormData({ ...formData, studentName: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label htmlFor="subjectName">Subject</Label>
                <Select
                  value={formData.subjectId || ''}
                  onValueChange={(value) => {
                    const subject = subjects.find(s => s.id === value);
                    setFormData({ 
                      ...formData, 
                      subjectId: value,
                      subjectName: subject?.name || ''
                    });
                  }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select subject" />
                  </SelectTrigger>
                  <SelectContent>
                    {subjects.map(subject => (
                      <SelectItem key={subject.id} value={subject.id}>
                        {subject.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label htmlFor="examType">Exam Type</Label>
                <Select
                  value={formData.examType || ''}
                  onValueChange={(value) => setFormData({ ...formData, examType: value })}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select exam type" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="quiz">Quiz</SelectItem>
                    <SelectItem value="midterm">Midterm</SelectItem>
                    <SelectItem value="final">Final</SelectItem>
                    <SelectItem value="assignment">Assignment</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="score">Score</Label>
                  <Input
                    id="score"
                    type="number"
                    value={formData.score || ''}
                    onChange={(e) => setFormData({ ...formData, score: parseInt(e.target.value) })}
                    required
                  />
                </div>
                <div>
                  <Label htmlFor="maxScore">Max Score</Label>
                  <Input
                    id="maxScore"
                    type="number"
                    value={formData.maxScore || ''}
                    onChange={(e) => setFormData({ ...formData, maxScore: parseInt(e.target.value) })}
                    required
                  />
                </div>
              </div>
              <div>
                <Label htmlFor="date">Date</Label>
                <Input
                  id="date"
                  type="date"
                  value={formData.date || ''}
                  onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                  required
                />
              </div>
            </>
          )}

          {type === 'exam' && (
            <>
              <div>
                <Label htmlFor="title">Exam Title</Label>
                <Input
                  id="title"
                  value={formData.title || ''}
                  onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                  required
                />
              </div>
              <div>
                <Label htmlFor="subjectName">Subject</Label>
                <Select
                  value={formData.subjectId || ''}
                  onValueChange={(value) => {
                    const subject = subjects.find(s => s.id === value);
                    setFormData({ 
                      ...formData, 
                      subjectId: value,
                      subjectName: subject?.name || ''
                    });
                  }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select subject" />
                  </SelectTrigger>
                  <SelectContent>
                    {subjects.map(subject => (
                      <SelectItem key={subject.id} value={subject.id}>
                        {subject.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="grade">Grade</Label>
                  <Select
                    value={formData.grade || ''}
                    onValueChange={(value) => setFormData({ ...formData, grade: value })}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Grade" />
                    </SelectTrigger>
                    <SelectContent>
                      {gradesList.map(grade => (
                        <SelectItem key={grade} value={grade}>
                          {grade.replace('-', ' ').toUpperCase()}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <Label htmlFor="section">Section</Label>
                  <Select
                    value={formData.section || ''}
                    onValueChange={(value) => setFormData({ ...formData, section: value })}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Section" />
                    </SelectTrigger>
                    <SelectContent>
                      {sections.map(section => (
                        <SelectItem key={section} value={section}>{section}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>
              <div>
                <Label htmlFor="type">Exam Type</Label>
                <Select
                  value={formData.type || ''}
                  onValueChange={(value) => setFormData({ ...formData, type: value })}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select type" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="quiz">Quiz</SelectItem>
                    <SelectItem value="midterm">Midterm</SelectItem>
                    <SelectItem value="final">Final</SelectItem>
                    <SelectItem value="assignment">Assignment</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="date">Date</Label>
                  <Input
                    id="date"
                    type="date"
                    value={formData.date || ''}
                    onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                    required
                  />
                </div>
                <div>
                  <Label htmlFor="duration">Duration (minutes)</Label>
                  <Input
                    id="duration"
                    type="number"
                    value={formData.duration || ''}
                    onChange={(e) => setFormData({ ...formData, duration: parseInt(e.target.value) })}
                    required
                  />
                </div>
              </div>
              <div>
                <Label htmlFor="maxScore">Max Score</Label>
                <Input
                  id="maxScore"
                  type="number"
                  value={formData.maxScore || ''}
                  onChange={(e) => setFormData({ ...formData, maxScore: parseInt(e.target.value) })}
                  required
                />
              </div>
              <div>
                <Label htmlFor="instructions">Instructions</Label>
                <Textarea
                  id="instructions"
                  value={formData.instructions || ''}
                  onChange={(e) => setFormData({ ...formData, instructions: e.target.value })}
                />
              </div>
            </>
          )}

          <div className="flex justify-end space-x-2">
            <Button type="button" variant="outline" onClick={onClose}>
              Cancel
            </Button>
            <Button type="submit">
              {isEditing ? 'Update' : 'Create'}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
};
{/* <TabsContent value="academic-years" className="space-y-4">
  <AcademicYearManagement />
  {/* Registration controls for open semesters */}
  // {semesters.filter(sem => sem.registrationOpen).map(sem => (
  //   <RegistrationControl key={sem.id} semester={sem} />
  // ))}
// </TabsContent> */}